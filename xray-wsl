#!/bin/bash
set -euo pipefail

#######################################
# Xray WSL Bootstrap - Main CLI
# Interactive menu-driven interface
#######################################

# Source libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/common.sh"

# Colors and styling (check if already defined to avoid readonly conflicts)
if [[ -z "${RED:-}" ]]; then
    readonly RED='\033[0;31m'
    readonly GREEN='\033[0;32m'
    readonly YELLOW='\033[1;33m'
    readonly BLUE='\033[0;34m'
    readonly NC='\033[0m'
fi

# Colors are loaded from common.sh

# Version
readonly VERSION=$(cat "$SCRIPT_DIR/.version" 2>/dev/null || echo "unknown")

#######################################
# Print animated header
#######################################
print_header() {
    clear
    echo ""
    echo -e "${CYAN}╔══════════════════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}                                                                              ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}    ${BOLD}${MAGENTA}██╗  ██╗██████╗  █████╗ ██╗   ██╗    ██╗    ██╗███████╗██╗${NC}                ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}    ${BOLD}${MAGENTA}╚██╗██╔╝██╔══██╗██╔══██╗╚██╗ ██╔╝    ██║    ██║██╔════╝██║${NC}                ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}    ${BOLD}${MAGENTA} ╚███╔╝ ██████╔╝███████║ ╚████╔╝     ██║ █╗ ██║███████╗██║${NC}                ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}    ${BOLD}${MAGENTA} ██╔██╗ ██╔══██╗██╔══██║  ╚██╔╝      ██║███╗██║╚════██║██║${NC}                ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}    ${BOLD}${MAGENTA}██╔╝ ██╗██║  ██║██║  ██║   ██║       ╚███╔███╔╝███████║███████╗${NC}           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}    ${BOLD}${MAGENTA}╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝        ╚══╝╚══╝ ╚══════╝╚══════╝${NC}           ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                                              ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}               ${BOLD}${CYAN}Xray VPN Bootstrap for WSL2${NC} ${DIM}v$VERSION${NC}                    ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                  ${DIM}Easy setup • Multiple protocols • Full automation${NC}        ${CYAN}║${NC}"
    echo -e "${CYAN}║${NC}                                                                              ${CYAN}║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

#######################################
# Check system requirements
#######################################
check_requirements() {
    local missing_reqs=()
    local warnings=()

    # Check WSL
    if ! grep -qi microsoft /proc/version 2>/dev/null; then
        warnings+=("Not running in WSL environment")
    fi

    # Check systemd
    if ! command -v systemctl >/dev/null 2>&1; then
        missing_reqs+=("systemd (systemctl command not found)")
    elif ! systemctl --version >/dev/null 2>&1; then
        missing_reqs+=("systemd not properly initialized")
    fi

    # Check required commands
    local required_commands=("curl" "jq" "unzip")
    for cmd in "${required_commands[@]}"; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing_reqs+=("$cmd")
        fi
    done

    # Check optional commands
    local optional_commands=("zbarimg")
    for cmd in "${optional_commands[@]}"; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            warnings+=("$cmd (optional, needed for QR code scanning)")
        fi
    done

    # Check script permissions
    local script_dir="$SCRIPT_DIR/scripts"
    if [[ -d "$script_dir" ]]; then
        local scripts_missing_exec=()
        for script in "$script_dir"/*.sh; do
            if [[ -f "$script" && ! -x "$script" ]]; then
                scripts_missing_exec+=("$(basename "$script")")
            fi
        done

        if [[ ${#scripts_missing_exec[@]} -gt 0 ]]; then
            warnings+=("Some scripts are not executable: ${scripts_missing_exec[*]}")
            warnings+=("Run: chmod +x $script_dir/*.sh")
        fi
    fi

    # Report results
    if [ ${#missing_reqs[@]} -gt 0 ]; then
        echo -e "${RED}✗ Missing required dependencies:${NC}"
        for req in "${missing_reqs[@]}"; do
            echo -e "  ${YELLOW}•${NC} $req"
        done
        echo ""
        echo -e "${CYAN}Install with:${NC} ${BOLD}sudo apt update && sudo apt install -y curl jq unzip zbar-tools${NC}"
        return 1
    fi

    if [ ${#warnings[@]} -gt 0 ]; then
        echo -e "${YELLOW}⚠ Warnings:${NC}"
        for warn_msg in "${warnings[@]}"; do
            echo -e "  ${YELLOW}•${NC} $warn_msg"
        done
        echo ""
    fi

    return 0
}

#######################################
# Get service status with colors
#######################################
get_service_status() {
    if ! command -v systemctl >/dev/null 2>&1; then
        echo -e "${RED}✗ systemd not available${NC}"
        return
    fi

    if systemctl is-active --quiet xray-wsl 2>/dev/null; then
        echo -e "${GREEN}✓ Running${NC}"
    else
        echo -e "${RED}✗ Stopped${NC}"
    fi
}

#######################################
# Get configuration status
#######################################
get_config_status() {
    if [[ -f ".env" ]]; then
        echo -e "${GREEN}✓ Configured${NC}"
    else
        echo -e "${YELLOW}! Not configured${NC}"
    fi
}

#######################################
# Print main menu
#######################################
print_menu() {
    local service_status config_status
    service_status=$(get_service_status)
    config_status=$(get_config_status)

    echo -e "${BOLD}${BLUE}Main Menu${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo ""

    echo -e "${CYAN}Status:${NC}"
    echo -e "  Service: $service_status"
    echo -e "  Config:  $config_status"
    echo ""

    echo -e "${CYAN}Configuration:${NC}"
    echo -e "  ${YELLOW}1.${NC} ${BOLD}Setup Configuration${NC}     ${DIM}Interactive config setup${NC}"
    echo -e "  ${YELLOW}2.${NC} ${BOLD}Import from URL${NC}         ${DIM}Parse vless://, vmess://, trojan:// URLs${NC}"
    echo -e "  ${YELLOW}3.${NC} ${BOLD}Import from QR Code${NC}     ${DIM}Scan QR code image file${NC}"
    echo -e "  ${YELLOW}4.${NC} ${BOLD}Edit Configuration${NC}      ${DIM}Manually edit .env file${NC}"
    echo ""

    echo -e "${CYAN}Installation & Management:${NC}"
    echo -e "  ${YELLOW}5.${NC} ${BOLD}Install Xray${NC}            ${DIM}Download and install Xray service${NC}"
    echo -e "  ${YELLOW}6.${NC} ${BOLD}Service Control${NC}         ${DIM}Start/stop/restart service${NC}"
    echo -e "  ${YELLOW}7.${NC} ${BOLD}Check Connection${NC}        ${DIM}Verify VPN connection and IP${NC}"
    echo -e "  ${YELLOW}8.${NC} ${BOLD}View Logs${NC}              ${DIM}Show service logs${NC}"
    echo ""

    echo -e "${CYAN}Tools:${NC}"
    echo -e "  ${YELLOW}9.${NC} ${BOLD}System Check${NC}           ${DIM}Verify system requirements${NC}"
    echo -e "  ${YELLOW}10.${NC} ${BOLD}Fix Permissions${NC}        ${DIM}Make scripts executable${NC}"
    echo -e "  ${YELLOW}11.${NC} ${BOLD}Generate Config${NC}        ${DIM}Regenerate Xray config file${NC}"
    echo -e "  ${YELLOW}12.${NC} ${BOLD}Uninstall${NC}              ${DIM}Remove Xray completely${NC}"
    echo ""

    echo -e "  ${YELLOW}h.${NC} Help                     ${YELLOW}q.${NC} Quit"
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════════════════${NC}"
}

#######################################
# Fix script permissions automatically
#######################################
fix_script_permissions() {
    echo -e "${CYAN}Fixing script permissions...${NC}"

    local script_dir="$SCRIPT_DIR/scripts"
    local fixed_count=0

    if [[ -d "$script_dir" ]]; then
        for script in "$script_dir"/*.sh; do
            if [[ -f "$script" && ! -x "$script" ]]; then
                if chmod +x "$script" 2>/dev/null; then
                    echo -e "  ${GREEN}✓${NC} Made executable: $(basename "$script")"
                    ((fixed_count++))
                else
                    echo -e "  ${RED}✗${NC} Failed to fix: $(basename "$script")"
                fi
            fi
        done

        # Also fix main CLI if needed
        if [[ ! -x "$0" ]]; then
            if chmod +x "$0" 2>/dev/null; then
                echo -e "  ${GREEN}✓${NC} Made executable: xray-wsl"
                ((fixed_count++))
            fi
        fi

        if [[ $fixed_count -gt 0 ]]; then
            echo -e "${GREEN}Fixed $fixed_count script(s)${NC}"
        else
            echo -e "${YELLOW}All scripts already have correct permissions${NC}"
        fi
    else
        echo -e "${RED}Scripts directory not found${NC}"
    fi

    echo ""
    pause
}

#######################################
# Get user menu choice
#######################################
get_choice() {
    echo -ne "${BOLD}Choose an option:${NC} "
    read -r choice
    echo "$choice"
}

#######################################
# Execute script with error handling
#######################################
execute_script() {
    local script="$1"
    shift
    local script_path="$SCRIPT_DIR/$script"

    if [[ ! -f "$script_path" ]]; then
        echo -e "${RED}✗ Script not found: $script${NC}"
        return 1
    fi

    if [[ ! -x "$script_path" ]]; then
        echo -e "${YELLOW}Setting execute permission for $script${NC}"
        chmod +x "$script_path"
    fi

    echo -e "${BLUE}Executing: $script${NC}"
    echo -e "${DIM}────────────────────────────────────────────────────────────────────${NC}"

    if "$script_path" "$@"; then
        echo -e "${DIM}────────────────────────────────────────────────────────────────────${NC}"
        echo -e "${GREEN}✓ Completed successfully${NC}"
        return 0
    else
        echo -e "${DIM}────────────────────────────────────────────────────────────────────${NC}"
        echo -e "${RED}✗ Failed with exit code $?${NC}"
        return 1
    fi
}

#######################################
# Execute command with sudo check
#######################################
execute_with_sudo() {
    local script="$1"
    shift

    if [[ $EUID -eq 0 ]]; then
        execute_script "$script" "$@"
    else
        echo -e "${YELLOW}This operation requires root privileges${NC}"
        echo -e "${CYAN}Running with sudo...${NC}"
        sudo "$SCRIPT_DIR/$script" "$@"
    fi
}

#######################################
# Service control submenu
#######################################
service_control_menu() {
    while true; do
        clear
        print_header

        echo -e "${BOLD}${BLUE}Service Control${NC}"
        echo -e "${BLUE}═══════════════════════════════════════════════════════════════════════════${NC}"
        echo ""

        local service_status
        service_status=$(get_service_status)
        echo -e "Current status: $service_status"
        echo ""

        echo -e "${YELLOW}1.${NC} Start service"
        echo -e "${YELLOW}2.${NC} Stop service"
        echo -e "${YELLOW}3.${NC} Restart service"
        echo -e "${YELLOW}4.${NC} Service status"
        echo -e "${YELLOW}5.${NC} Enable autostart"
        echo -e "${YELLOW}6.${NC} Disable autostart"
        echo ""
        echo -e "${YELLOW}b.${NC} Back to main menu"
        echo ""

        echo -ne "${BOLD}Choose an option:${NC} "
        read -r choice

        case "$choice" in
            1) execute_with_sudo "scripts/manage.sh" start ;;
            2) execute_with_sudo "scripts/manage.sh" stop ;;
            3) execute_with_sudo "scripts/manage.sh" restart ;;
            4) execute_script "scripts/manage.sh" status ;;
            5) execute_with_sudo "scripts/manage.sh" enable ;;
            6) execute_with_sudo "scripts/manage.sh" disable ;;
            b|B) return 0 ;;
            *) echo -e "${RED}Invalid choice. Please try again.${NC}" ;;
        esac

        if [[ "$choice" != "b" && "$choice" != "B" ]]; then
            echo ""
            echo -e "${DIM}Press any key to continue...${NC}"
            read -n 1 -s
        fi
    done
}

#######################################
# Import URL with validation
#######################################
import_url() {
    echo -e "${CYAN}Import from URL${NC}"
    echo -e "${DIM}Supported formats: vless://, vmess://, trojan://${NC}"
    echo ""

    echo -ne "${BOLD}Enter proxy URL:${NC} "
    read -r url

    if [[ -z "$url" ]]; then
        echo -e "${RED}✗ URL is required${NC}"
        return 1
    fi

    execute_script "scripts/parse-url.sh" "$url"
}

#######################################
# Import QR code
#######################################
import_qr() {
    echo -e "${CYAN}Import from QR Code${NC}"
    echo -e "${DIM}Supported formats: PNG, JPEG, GIF${NC}"
    echo ""

    echo -ne "${BOLD}Enter QR code file path:${NC} "
    read -r qr_file

    if [[ -z "$qr_file" ]]; then
        echo -e "${RED}✗ File path is required${NC}"
        return 1
    fi

    if [[ ! -f "$qr_file" ]]; then
        echo -e "${RED}✗ File not found: $qr_file${NC}"
        return 1
    fi

    execute_script "scripts/parse-url.sh" --qr "$qr_file"
}

#######################################
# Edit configuration file
#######################################
edit_config() {
    local editor="${EDITOR:-nano}"

    if [[ ! -f ".env" ]]; then
        if [[ -f ".env.example" ]]; then
            echo -e "${YELLOW}No .env file found. Creating from example...${NC}"
            cp .env.example .env
            chmod 600 .env
        else
            echo -e "${RED}✗ No configuration file found${NC}"
            return 1
        fi
    fi

    echo -e "${CYAN}Opening configuration editor...${NC}"
    echo -e "${DIM}Editor: $editor${NC}"

    $editor .env

    echo -e "${GREEN}✓ Configuration saved${NC}"
}

#######################################
# Show help
#######################################
show_help() {
    echo -e "${BOLD}${CYAN}Xray WSL Bootstrap Help${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════════════════${NC}"
    echo ""

    echo -e "${BOLD}Quick Start:${NC}"
    echo -e "1. Setup configuration (option 1) or import from URL/QR (options 2-3)"
    echo -e "2. Install Xray (option 5)"
    echo -e "3. Check connection (option 7)"
    echo ""

    echo -e "${BOLD}Configuration Sources:${NC}"
    echo -e "• ${YELLOW}URL formats:${NC} vless://..., vmess://..., trojan://..."
    echo -e "• ${YELLOW}QR codes:${NC} PNG/JPEG images containing proxy URLs"
    echo -e "• ${YELLOW}Manual:${NC} Interactive step-by-step setup"
    echo ""

    echo -e "${BOLD}System Requirements:${NC}"
    echo -e "• WSL2 with Ubuntu 22.04+"
    echo -e "• systemd enabled"
    echo -e "• curl, jq, unzip installed"
    echo -e "• Root access (sudo)"
    echo ""

    echo -e "${BOLD}Troubleshooting:${NC}"
    echo -e "• Use ${YELLOW}System Check${NC} (option 9) to verify requirements"
    echo -e "• Check logs with ${YELLOW}View Logs${NC} (option 8)"
    echo -e "• Service issues: use ${YELLOW}Service Control${NC} (option 6)"
    echo ""

    echo -e "${BOLD}Support:${NC}"
    echo -e "• GitHub: https://github.com/fixplizz-dev/xray-wsl-bootstrap"
    echo -e "• Issues: https://github.com/fixplizz-dev/xray-wsl-bootstrap/issues"
}

#######################################
# Main menu loop
#######################################
main_menu() {
    while true; do
        print_header
        print_menu

        echo -ne "${BOLD}Choose an option [0-12]:${NC} "
        read -r choice
        echo ""

        case "$choice" in
            1)
                execute_script "scripts/setup-config.sh"
                ;;
            2)
                import_url
                ;;
            3)
                import_qr
                ;;
            4)
                edit_config
                ;;
            5)
                execute_with_sudo "scripts/install.sh"
                ;;
            6)
                service_control_menu
                continue
                ;;
            7)
                execute_script "scripts/check-ip.sh"
                ;;
            8)
                execute_script "scripts/manage.sh" logs
                ;;
            9)
                echo -e "${CYAN}System Requirements Check${NC}"
                echo -e "${DIM}────────────────────────────────────────────────────────────────────${NC}"
                if check_requirements; then
                    echo -e "${GREEN}✓ All requirements satisfied${NC}"
                else
                    echo -e "${RED}✗ Some requirements missing${NC}"
                fi
                ;;
            10)
                fix_script_permissions
                ;;
            11)
                execute_script "scripts/generate-config.sh"
                ;;
            12)
                echo -e "${YELLOW}⚠ This will completely remove Xray and all configuration${NC}"
                echo -ne "${BOLD}Are you sure? (y/N):${NC} "
                read -r confirm
                if [[ "$confirm" =~ ^[Yy]$ ]]; then
                    execute_with_sudo "scripts/uninstall.sh"
                fi
                ;;
            h|H|help)
                show_help
                ;;
            q|Q|quit|exit)
                echo -e "${CYAN}Thank you for using Xray WSL Bootstrap!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid choice. Please try again.${NC}"
                ;;
        esac

        if [[ "$choice" != "6" ]]; then
            echo ""
            echo -e "${DIM}Press any key to continue...${NC}"
            read -n 1 -s
        fi
    done
}

#######################################
# Print usage information
#######################################
print_usage() {
    cat << EOF
Xray WSL Bootstrap - Main CLI

USAGE:
    $0 [COMMAND] [OPTIONS]

COMMANDS:
    setup           Interactive configuration setup
    install         Install Xray service
    start           Start Xray service
    stop            Stop Xray service
    restart         Restart Xray service
    status          Show service status
    logs            Show service logs
    check-ip        Check VPN connection
    uninstall       Remove Xray completely

    help            Show help information
    version         Show version information

OPTIONS:
    -h, --help      Show this help message

EXAMPLES:
    # Interactive menu (default)
    $0

    # Direct commands
    $0 setup
    $0 install
    $0 check-ip

EOF
}

#######################################
# Handle command line arguments
#######################################
handle_args() {
    case "${1:-}" in
        setup)
            execute_script "scripts/setup-config.sh"
            ;;
        install)
            execute_with_sudo "scripts/install.sh"
            ;;
        start)
            execute_with_sudo "scripts/manage.sh" start
            ;;
        stop)
            execute_with_sudo "scripts/manage.sh" stop
            ;;
        restart)
            execute_with_sudo "scripts/manage.sh" restart
            ;;
        status)
            execute_script "scripts/manage.sh" status
            ;;
        logs)
            execute_script "scripts/manage.sh" logs
            ;;
        check-ip)
            execute_script "scripts/check-ip.sh"
            ;;
        uninstall)
            execute_with_sudo "scripts/uninstall.sh"
            ;;
        version)
            echo "Xray WSL Bootstrap v$VERSION"
            ;;
        help|--help|-h)
            print_usage
            ;;
        "")
            main_menu
            ;;
        *)
            echo -e "${RED}Unknown command: $1${NC}"
            print_usage
            exit 1
            ;;
    esac
}

#######################################
# Main execution
#######################################
main() {
    # Handle direct commands
    if [[ $# -gt 0 ]]; then
        handle_args "$@"
        exit $?
    fi

    # Interactive menu
    main_menu
}

# Execute main function with all arguments
main "$@"